<!DOCTYPE html>
<!-- //md5加密 按字母顺序，secretkey放在最后 -->
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>key4开空一阶5min</title>
	<style>
		th {background: #ccc;}
		table td,table th{
			font-size:14px;
			font-weight: 400;
			text-align: center;
			width:12%;
		}
		table {width:800px; border:1px solid #666; margin-bottom: 30px; max-height:200px; overflow: scroll;}

	</style>
</head>
<body>
	<div id="app">
		<button @click="start">启动</button>
		<button @click="showOrder1">查看未完成订单</button>
		<button @click="futureTrade(1000,1,1)">下单</button>
		<button @click="futureOrderInfo(-1)">查-1</button>
		<button @click="futureCancelOrder(6465769535)">撤xxx</button>
		<button @click="testspeed">test speed</button>
		<!-- <button @click="trans">换仓</button> -->
		{{receiveTime - sendTime}}

		<p>dueAmount: {{dueAmount}}</p>



		<p>未完成的订单（待成交，部分成交）</p>
		<table v-show="unfinishArr.length>0" id="unfinished">
			<tr>
				<th>订单号</th><th>委托数量/成交数量</th><th>委托价格</th><th>成交均价</th><th>订单类型</th><th>委托时间</th><th>手续费</th><th>订单状态</th>
			</tr>
			<tr v-for="item in unfinishArr">
				<td>{{item['order_id']}}</td>
				<td>{{item.amount+"/"+item.deal_amount}}</td>
				<td>{{item.price}}</td>
				<td>{{item.price_avg}}</td>
				<td>{{item.type==1?"开多":(item.type==3?"平多":item.type)}}</td>
				<td>{{formatDate(item.create_date)}}</td>
				<td>{{item.fee}}</td>
				<td>{{formatStatus(item.status)}}</td>
			</tr>
		</table>
		<p>nextTickAmount 有所成交的多单（只增不减）</p>
		<table v-show="nextTickAmount.length>0" id="hasdealDuo">
			<tr>
				<th>订单号</th><th>委托数量/成交数量</th><th>委托价格</th><th>成交均价</th><th>订单类型</th><th>委托时间</th><th>手续费</th><th>订单状态</th>
			</tr>
			<tr v-for="item in nextTickAmount">
				<td>{{item['order_id']}}</td>
				<td>{{item.amount+"/"+item.deal_amount}}</td>
				<td>{{item.price}}</td>
				<td>{{item.price_avg}}</td>
				<td>{{item.type==1?"开多":(item.type==3?"平多":item.type)}}</td>
				<td>{{formatDate(item.create_date)}}</td>
				<td>{{item.fee}}</td>
				<td>{{formatStatus(item.status)}}</td>
			</tr>
		</table>


		<p>allOrder (只遍历非平单)</p>
		<table id="processing">
			<tr>
				<th>订单号</th><th>cycle时间</th>
			</tr>
			<tr v-for="item in allOrder">
				<td>{{item['order_id']}}</td>				
				<td>{{formatDate(item.order_time)}}</td>

			</tr>
		</table>
		<div>
			<p v-if="startTime">
				系统启动时间：{{formatDate(startTime)}}
			</p>
		</div>
		<div id="status">
			<p v-if="connected>0">CONNECTED:+{{connected}}</p>
			<p v-if="error>0">ERROR:+{{error}} {{errorStr}}</p>
			<p v-if="disconnected>0">DISCONNECTED:+{{disconnected}}</p>
		</div>
		<div id="output"></div>
	</div>
</body>
<script type="text/javascript" src="MD5.js"></script>
<script src="../jquery-3.2.1.js"></script>
<script src="../vue.js"></script>
<script>
var app = new Vue({
	el:"#app",
	data: {
		EMA3:'',
		EMA5:'',
		EMA10:'',
		okCoinWebSocket:{},

		posState: '',
		rateFlag: '',
		nextDealTime: '',
		curTime: '',

		//开多订单库
		proxyingArr: [],
		//正在请求中的开多订单库
		proxyingArr1: [],
		//平多订单库
		sellingArr:[],

		//当前kline开盘价
		kaipan15min:'',
		//当前cycle的时间戳，与开盘价一同更新
		cur15minTime:'',
		
		
		//所有未完成订单 {order_id:'',seq:''}
		allOrder:[],
		//所有已完成、未完成订单 
		finishArr: [],
		unfinishArr: [],
		//系统启动时间
		startTime: '',
		//将要撤单的订单
		retreatArr: [],
		//将要平的多单
		plantArr: [],
		//将要平仓的多单
		nextTickAmount: [],
		//打印信息
		programInfo: [],
		connected: 0,
		error: 0,
		disconnected: 0,
		errorStr: '',

		cycleNum:300000,
		subKline:'ok_sub_futureusd_btc_kline_quarter_5min',
		kaiduoRate1:1.00201,
		kaiduoRate2:0.001,
		pingduoRate1:0.996,
		//pingduoRate1:0.99402,
		pingduoRate2:1.0014,
		deltaLimit:30000,
		delta:0,
		amount:8,
		changingAmount: 0,
		leverRate:20,

		origin:1.00201,


		curOrder:'',
		dueAmount:0,

		receiveTime:0,
		sendTime:0,


		allPlantArr:[],
		//移仓
		transArr:[],
		handleTransArr:[]






	},
	watch: {

	},
	computed: {


	},
	methods: {
		initEMA: function(arr){
			var $this = this;
		},

		testspeed: function(){
			var $this = this;
			var curTime = new Date();
			$this.sendTime = curTime;
			$this.futureTrade(1000,1,1);
		},
		ensureAllOrder: function(){
			var $this = this;
			console.log("im checking lost orders...")

			$this.futureOrderInfo(-1);
		},
		formatStatus: function(s){
			var $this = this;
			switch(s){
				case 1: return "部分成交";
				break;
				case 2: return "全部成交";
				break;
				case 4: return "撤单处理中";
				break;
				case -1: return "撤单";
				break;
				case 0: return "等待成交";
				break;
				default:
				return '';
				break;
			}
		},
		formatDate: function(date){
			var d = new Date(date);
			return d.getFullYear()+"年"+(d.getMonth()+1)+"月"+d.getDate()+"日"+d.getHours()+":"+d.getMinutes()+":"+d.getSeconds();
		},
		start: function(){
			var $this = this;
			$this.okCoinWebSocket.init("wss://real.okex.com:10440/websocket/okexapi", "e4efd00c-64eb-49db-a010-9897ff89f61f", "");
			$this.startTime = new Date().getTime();

		},
		checkOrders: function(){
			var $this = this;

			//$this.futureOrderInfo(-1);
			for(var i=0; i<$this.allOrder.length; i++){
				//console.info("checkorders")
				//$this.reqCount++
				if($this.allOrder[i].type!=4){
					$this.futureOrderInfo($this.allOrder[i].order_id);
				}
				
			}
		},
		removeOrder: function(arr, id){
			var $this = this;
			for(var i=0; i<arr.length; i++){
				if(arr[i].order_id == id){
					var temp = arr[i]
					arr.splice(i, 1);
					return temp;
				}
			}
			return -1;
		},
		addOrder: function(arr, id, order){
			var $this = this;
			for(var i=0; i<arr.length; i++){
				if(arr[i].order_id == id){
					return;
				}
			}
			arr.push(order);
		},
		updateOrder: function(arr, id, order){
			var $this = this;
			for(var i=0; i<arr.length; i++){
				if(arr[i].order_id == id){
					var temp = arr[i]
					arr[i] = order;
					return temp;
				}
			}
			//如果没有查到
			//arr.push(order)
			return -1;
		},
		searchOrder: function(arr, id){
			var $this = this;
			for(var i=0; i<arr.length; i++){
				if(arr[i].order_id == id){
					return i;
				}
			}
			return -1;
		},
		search:function(arr,num){
			var $this = this;
			for(var i=0; i<arr.length; i++){
				if(arr[i] == num){
					return i;
				}
			}
			return -1;
		},
		onMessage: function(e) {
			var $this = this;
			//$this.recCount++;
			console.log($this.formatDate(new Date().getTime()) + ": " + e.data)
			var array = JSON.parse(e.data);
			//msg为除了pong以外的数据消息
			if(array.length==1){
				var msg = array[0];
				if(msg){
					if(msg['channel']=="ok_sub_futureusd_btc_kline_quarter_15min"){
						if(msg['data'].length>1){
							$this.initEMA(msg.data);
							
						}else{

						}
						var data = msg['data'][0];

						if($this.kaipan15min == ''){
							$this.kaipan15min = data[1];
							$this.cur15minTime = data[0];
						}

						if($this.cur15minTime!='' && $this.cur15minTime < data[0]){
							console.info($this.cur15minTime+","+data[0])
							$this.kaipan15min = data[1];
							$this.cur15minTime = data[0];
							
							var curTime = new Date().getTime();
							var delta = curTime%$this.cycleNum;
							$this.delta = delta;
							//if(delta>$this.deltaLimit){
							if(curTime>$this.cur15minTime+30000){
								console.info("k线数据来的太慢了。等下一个cycle")
							}else{
								//$this.makeorder();							
							}
							//$this.makePlantOrder();
						}
						
						
						


					}
					else if(msg['channel']=="ok_futureusd_orderinfo"){
						console.info("okinfo come in")
						if(msg['data'].result&&msg['data'].result!='false'){
							for(var i=0; i<msg['data'].orders.length; i++){
								var order = msg['data'].orders[i];
								
								if(order.lever_rate!=10){
									continue;
								}
								if(order.symbol=='ltc_usd'){
									continue;
								}
								
								

							}
						}
					}
					else if(msg['channel']=="ok_futureusd_trade"){

						if(msg['data'].result&&msg['data'].result!='false'){
							
							var time = new Date().getTime()
							$this.receiveTime = time;
							var order = {
								order_id: msg['data'].order_id,
								order_time: time-time%$this.cycleNum
							}

							$this.allOrder.push(order);
							//$this.proxyingArr.push(order);
							
						}
					}else if(msg['channel']=='ok_futureusd_cancel_order'){

						if(msg['data'].result&&msg['data'].result!='false'){
							var id = msg['data'].order_id;


							
							$this.removeOrder($this.retreatArr,id);

							
						}
					}else if(msg['channel']=="ok_sub_futureusd_positions"){
						if(msg['data']['symbol']=='btc_usd'){
							var positionArr = msg['data']['positions']
							var dAmount = 0;
							var kAmount = 0;  
							for(var i in positionArr){
								if(positionArr[i]['position']=='1'&&positionArr[i]['lever_rate']==20){
									console.info("dudaole position in array0")
									dAmount += parseFloat(positionArr[i]['hold_amount']);
								}else if(positionArr[i]['position']=='2'&&positionArr[i]['lever_rate']==20){
									kAmount += parseFloat(positionArr[i]['hold_amount']);
								}
							}
							var delta = dAmount - kAmount;
							var max = dAmount - kAmount > 0 ? dAmount : kAmount;
							var sum = dAmount+kAmount;


							
							
							var ls = window.localStorage;
							
							if(Math.abs(delta)<=$this.amount*6){
							//多空平衡
								$this.rateFlag = "0";
								ls.setItem("rateFlag","0");

								$this.kaiduoRate1 = $this.origin;

							}else if(delta>0){
								$this.kaiduoRate1 = 1.001
							//下跌后期、上涨前期、上涨中前期
								if(kAmount<=sum*0.15){
									$this.rateFlag = "1";
									ls.setItem("rateFlag","1");
									
								}
		
							}else{
								//如果damount==0, 0.999之后会被0.997覆盖
								$this.kaiduoRate1 = 1.003
							//上涨后期、下跌前期、下跌中前期
								if(dAmount<=sum*0.15){
									$this.rateFlag = "2";
									ls.setItem("rateFlag","2");
									
								}

							}

							//尝试从缓存中读取rateFlag
							if(ls.getItem("rateFlag")!=null){
								$this.rateFlag = ls.getItem("rateFlag")
							}

							if($this.rateFlag == "1"){
								$this.posState = 1;
								$this.kaiduoRate1 = 1.003;
								
							}else if($this.rateFlag == "2"){
								
								$this.posState = 2;
								
							}else{
								//不是1也不是2,那就是在中前期或中后期
								if($this.kaiduoRate1 == 1.001){
									console.info("上涨中前期（平衡后的常规 d > k），开空概率1.001")
									$this.posState = 3;
								}else if($this.kaiduoRate1 == $this.origin){
									console.info("多空平衡中...")
									$this.posState = 0;
								}else{
									$this.posState = 4;
									console.info("下跌中后期（平衡后的常规 d < k）,开空概率1.003")
								}
							}

							//危险状态，只更新posState，不更新rateFlag
							if(sum>$this.amount*100){
								$this.kaiduoRate1 = 1.01;
								$this.posState = -1;
							}

							

						}
						

					}
				}
			}else{
				var msg = array;
				for(var i in msg){
					if(msg[i]['channel']=="ok_sub_futureusd_positions"){
						if(msg[i]['data']['symbol']=='btc_usd'){
							var positionArr = msg[i]['data']['positions']
							var dAmount=0;
							var kAmount=0
							for(var i in positionArr){
								
								if(positionArr[i]['position']=='1'&&positionArr[i]['lever_rate']==20){
									console.info("dudaole position in ARRAY")
									dAmount += parseFloat(positionArr[i]['hold_amount']);
									console.log("dAmount:"+dAmount)
								}else if(positionArr[i]['position']=='2'&&positionArr[i]['lever_rate']==20){
									kAmount += parseFloat(positionArr[i]['hold_amount']);
								}
								
							}
							var delta = dAmount - kAmount;
							var max = dAmount - kAmount > 0 ? dAmount : kAmount;
							var sum = dAmount+kAmount;


							var ls = window.localStorage;
							
							if(Math.abs(delta)<=$this.amount*6){
							//多空平衡
								$this.rateFlag = "0";
								ls.setItem("rateFlag","0");

								$this.kaiduoRate1 = $this.origin;

							}else if(delta>0){
								$this.kaiduoRate1 = 1.001
							//下跌后期、上涨前期、上涨中前期
								if(kAmount<=sum*0.15){
									$this.rateFlag = "1";
									ls.setItem("rateFlag","1");
									
								}
		
							}else{
								//如果damount==0, 0.999之后会被0.997覆盖
								$this.kaiduoRate1 = 1.003
							//上涨后期、下跌前期、下跌中前期
								if(dAmount<=sum*0.15){
									$this.rateFlag = "2";
									ls.setItem("rateFlag","2");
									
								}

							}

							//尝试从缓存中读取rateFlag
							if(ls.getItem("rateFlag")!=null){
								$this.rateFlag = ls.getItem("rateFlag")
							}

							if($this.rateFlag == "1"){
								$this.posState = 1;
								$this.kaiduoRate1 = 1.003;
								
							}else if($this.rateFlag == "2"){
								
								$this.posState = 2;
								
							}else{
								//不是1也不是2,那就是在中前期或中后期
								if($this.kaiduoRate1 == 1.001){
									console.info("上涨中前期（平衡后的常规 d > k），开空概率1.001")
									$this.posState = 3;
								}else if($this.kaiduoRate1 == $this.origin){
									console.info("多空平衡中...")
									$this.posState = 0;
								}else{
									$this.posState = 4;
									console.info("下跌中后期（平衡后的常规 d < k）,开空概率1.003")
								}
							}


							//危险状态，只更新posState，不更新rateFlag
							if(sum>$this.amount*100){
								$this.kaiduoRate1 = 1.01;
								$this.posState = -1;
							}

						}
						

					}
				}
			}
			



			if(array.event == 'pong') {
				$this.okCoinWebSocket.lastHeartBeat = new Date().getTime();
			} else {
				//$this.createTable(array);
			}
		},

		showOrder1: function(){
			var $this =  this;
			//$this.futureOrderInfo(-1);
			//this.futureTrade();
		},
		retreat: function(){
			var $this = this;
			
			for(var i=0; i<$this.retreatArr.length; i++){
				$this.futureCancelOrder($this.retreatArr[i].order_id);
			}

		},
		makeorder: function(){
			var $this = this;

			var price1 = parseFloat(($this.kaipan15min * $this.kaiduoRate1).toFixed(2));

			$this.futureTrade(price1,2,$this.amount);

			

		},


		print: function(message) {
			var status = document.getElementById("status");
			status.style.wordWrap = "break-word";
			status.innerHTML += message + "<br/>";
		},
		doSend: function(message) {
			var $this = this;
			//$this.sendCount++;
			//$this.print("SENT: " + message);
			if($this.okCoinWebSocket){
				var ws = $this.okCoinWebSocket.websocket
				this.send = function (message, callback) {
				    this.waitForConnection(function () {
				        ws.send(message);
				        if (typeof callback !== 'undefined') {
				          callback();
				        }
				    }, 100);
				};

				this.waitForConnection = function (callback, interval) {
				    if (ws.readyState === 1) {
				        callback();
				    } else {
				        var that = this;
				        // optional: implement backoff for interval here
				        setTimeout(function () {
				            that.waitForConnection(callback, interval);
				        }, interval);
				    }
				};


				this.send(message);
			}
			
			
		},
		onOpen: function(evt) {
			var $this = this;
			//$this.print("CONNECTED");
			$this.connected++;
			var str = "{'event':'addChannel','channel':'ok_sub_futureusd_btc_kline_quarter_15min'}"
			console.info(str);
			$this.doSend(str);
			//现货交易、合约交易测试
			//tradeTest();
			//$this.futurePositions();
			
		},
		createTable: function(array) {
			var $this = this;
			var str = '<table id="tdata" border="1">\r\n<tr id="tr0">\r\n';
			for ( var index in array[0]) {
				str += '<th>' + index + '</th>\r\n';
			}
			str += '</tr>\r\n';

			for ( var i = 0; i < array.length; i++) {
				str += '<tr id="tr' + (i+1) + '">\r\n';
				for ( var j in array[i]) {
					str += '<td>' + JSON.stringify(array[i][j]) + '</td>\r\n';
					//if(typeof array[i][j] == 'string' && array[i][j].indexOf("ok_") >= 0) {
						//console.log(array[i][j]);
					//}
				}
				str += '</tr>\r\n';
			}
			
			str += '</table>\r\n';
			document.getElementById("output").innerHTML = str;
		},
		finishOrder: function(order){
			var $this = this;
			
			//$this.finishArr.push(order);
		},
		
		onError: function(evt) {
			var $this = this;
			//$this.print('<span style="color: red;">ERROR:</span> ' + evt.data);
			$this.error++;
			$this.errorStr += error+'. '+evt.data;


		},
		onClose: function(evt) {
			var $this = this;
			//print("DISCONNECTED");
			$this.disconnected++;
		},
		checkConnect: function () {
			var $this = this;
			var ws = $this.okCoinWebSocket.websocket
			this.send = function (message, callback) {
			    this.waitForConnection(function () {
			        ws.send(message);
			        if (typeof callback !== 'undefined') {
			          callback();
			        }
			    }, 100);
			};

			this.waitForConnection = function (callback, interval) {
			    if (ws.readyState === 1) {
			        callback();
			    } else {
			        var that = this;
			        // optional: implement backoff for interval here
			        setTimeout(function () {
			            that.waitForConnection(callback, interval);
			        }, interval);
			    }
			};


			this.send("{'event':'ping'}");
			
			if ((new Date().getTime() - $this.okCoinWebSocket.lastHeartBeat) > $this.okCoinWebSocket.overtime) {
				console.log("socket 连接断开，正在尝试重新建立连接");
				//testWebSocket();
				$this.okCoinWebSocket.init("wss://real.okex.com:10440/websocket/okexapi", "e4efd00c-64eb-49db-a010-9897ff89f61f", "");

			}
		},
		futureOrderInfo: function(orderId) {
			//-1表示未完成订单
			console.info("i am querying info")
			var $this = this;
			var okCoinWebSocket = $this.okCoinWebSocket;
			/*var str = "api_key=" + okCoinWebSocket.api_key + "&contract_type=quarter&current_page=1&order_id=" + orderId + "&page_length=1&secret_key=" + okCoinWebSocket.secret_key + "&status=1&symbol=btc_usd"*/
			var str = "api_key=" + okCoinWebSocket.api_key + "&contract_type=quarter&current_page=1&order_id=" + orderId + "&page_length=50&status=1&symbol=btc_usd&secret_key=" + okCoinWebSocket.secret_key

			var sign = MD5(str);
			$this.doSend("{'event': 'addChannel','channel': 'ok_futureusd_orderinfo','parameters': {'api_key': '"
					+ okCoinWebSocket.api_key + "','sign': '" + sign + "','symbol': 'btc_usd','order_id': '" + orderId
					+ "','contract_type': 'quarter','status':'1','current_page':'1','page_length':'50'}}");
					
		},
		//合约下单
		futureTrade: function (price,type,amount) {
			var $this = this;
			var lv = $this.leverRate;
			
			$this.sendTime = new Date()
			var okCoinWebSocket = $this.okCoinWebSocket;
			var str = "amount="+ amount +"&api_key=" + okCoinWebSocket.api_key + 
					"&contract_type=quarter&lever_rate="+lv+"&match_price=0&price=" + price + "&symbol=btc_usd&type="+ type +"&secret_key=" + okCoinWebSocket.secret_key
	
			var sign = MD5(str);
			$this.doSend("{'event': 'addChannel','channel':'ok_futureusd_trade','parameters': {'api_key': '"+ okCoinWebSocket.api_key + "','sign': '" + sign + "','symbol': 'btc_usd','contract_type': 'quarter','amount': "+ amount +",'price': "+price+",'type': "+type+",'match_price': '0','lever_rate':" +lv+"}}");
			
		},
		//撤单
		futureCancelOrder: function(orderId) {
			var $this = this;
			var okCoinWebSocket = $this.okCoinWebSocket;
			var sign = MD5("api_key=" + okCoinWebSocket.api_key + "&contract_type=quarter&order_id=" + orderId
					+ "&symbol=btc_usd&secret_key=" + okCoinWebSocket.secret_key);
			$this.doSend("{'event': 'addChannel','channel': 'ok_futureusd_cancel_order','parameters': {'api_key': '"
					+ okCoinWebSocket.api_key + "','sign': '" + sign + "','symbol': 'btc_usd','order_id': '" + orderId
					+ "','contract_type': 'quarter'}}");
		},
		futurePositions: function() {
			var $this = this;
			var okCoinWebSocket = $this.okCoinWebSocket;
			var sign = MD5("api_key=" + okCoinWebSocket.api_key + "&secret_key=" + okCoinWebSocket.secret_key);
			$this.doSend("{'event':'addChannel','channel':'ok_sub_futureusd_positions','parameters' :{'api_key':'"
					+ okCoinWebSocket.api_key + "','sign':'" + sign + "'}}");
		}
			
	
			
	},
	mounted() {
		var $this = this;

		$this.okCoinWebSocket.init = function(uri, apiKey, secretKey) {
			this.wsUri = uri;
			this.api_key = apiKey;
			this.secret_key = secretKey;
			this.lastHeartBeat = new Date().getTime();
			this.overtime = 8000;
			var okCoinWebSocket = $this.okCoinWebSocket;
			
			okCoinWebSocket.websocket = new WebSocket(okCoinWebSocket.wsUri);
			
			okCoinWebSocket.websocket.onopen = function(evt) {
				$this.onOpen(evt)
			};
			okCoinWebSocket.websocket.onclose = function(evt) {
				$this.onClose(evt)
			};
			okCoinWebSocket.websocket.onmessage = function(evt) {
				$this.onMessage(evt)
			};
			okCoinWebSocket.websocket.onerror = function(evt) {
				$this.onError(evt)
			};
			
			setInterval($this.checkConnect,2000);
			
			setInterval($this.checkOrders,800);

			//尝试从撤单队列撤单
			setInterval($this.retreat,200);

			setInterval($this.ensureAllOrder,10000);


			var cur = new Date().getTime();
			var random = cur%1000*1000
			//0~999s
			if(random<300000||random>600000){
				random = 350000
			}


			setInterval(function(){
				var curTime = new Date().getTime();
				if($this.cycleNum-curTime%$this.cycleNum<20000||curTime%$this.cycleNum<20000){
					return;
				}
				if(curTime-$this.cur15minTime>$this.cycleNum){
					location.reload();
				}else{
					return;
				}
				
				
			},random)
		}

		$this.start();

		
				
	}
})
</script>
</html>