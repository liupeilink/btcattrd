<!DOCTYPE html>
<!-- //md5加密 按字母顺序，secretkey放在最后 -->
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>EMA-15min</title>
	<style>
		th {background: #ccc;}
		table td,table th{
			font-size:14px;
			font-weight: 400;
			text-align: center;
			width:12%;
		}
		table {width:800px; border:1px solid #666; margin-bottom: 30px; max-height:200px; overflow: scroll;}
		#error,#info{  float: left; width:400px; font-size:12px;}

	</style>
</head>
<body>
	<div id="app">
		<!-- <button @click="start">启动</button>
		<button @click="showOrder1">查看未完成订单</button>
		<button @click="futureTrade(1000,1,1)">下单</button>
		<button @click="futureOrderInfo(-1)">查-1</button>
		<button @click="futureCancelOrder(6465769535)">撤xxx</button>
		<button @click="testspeed">test speed</button> -->
		<!-- <button @click="trans">换仓</button> -->
		{{receiveTime - sendTime}}

		<p>dueAmount: {{dueAmount}}</p>

		<table v-if="objs.length>0">
			<tr>
				<th>时间</th><th>ema3</th><th>ema5</th><th>ema10</th><th>收盘价</th><th>isValid</th>
			</tr>
			<tr v-for="item in objs">
				<td>{{ item.formatTime }}</td><td>{{ item.ema3 }}</td><td>{{ item.ema5 }}</td><td>{{ item.ema10 }}</td><td>{{ item.price }}</td><td>{{ item.isValid }}</td>
			</tr>
		</table>

		<div id="wrap">
			<div id="error">
				<p>error_msg:</p>
				<p v-html="strError" style="color:red;"></p>
			</div>
			<div id="info">
				<p>info_msg:</p>
				<p v-html="strInfo" style=""></p>
			</div>
		</div>


		
		<div>
			<p v-if="startTime" >
				系统启动时间：{{formatDate(startTime)}}
			</p>
		</div>
		<div id="status">
			<p v-if="connected>0">CONNECTED:+{{connected}}</p>
			<p v-if="error>0">ERROR:+{{error}} {{errorStr}}</p>
			<p v-if="disconnected>0">DISCONNECTED:+{{disconnected}}</p>
		</div>
		<div id="output"></div>
	</div>
</body>
<script type="text/javascript" src="MD5.js"></script>
<script src="../jquery-3.2.1.js"></script>
<script src="../vue.js"></script>
<script>
var app = new Vue({
	el:"#app",
	data: {
		strError:'',
		strInfo:'',
		EMA3:'',
		EMA5:'',
		EMA10:'',
		obj1:{},
		obj2:{},
		obj3:{},
		//objs:[],
		okCoinWebSocket:{},

		posState: '',
		rateFlag: '',
		nextDealTime: '',
		curTime: '',

		//开多订单库
		proxyingArr: [],
		//正在请求中的开多订单库
		proxyingArr1: [],
		//平多订单库
		sellingArr:[],

		//当前kline开盘价
		kaipan15min:'',
		//当前cycle的时间戳，与开盘价一同更新
		cur15minTime:'',
		
		
		//所有未完成订单 {order_id:'',seq:''}
		allOrder:[],
		//所有已完成、未完成订单 
		finishArr: [],
		unfinishArr: [],
		//系统启动时间
		startTime: '',
		//将要撤单的订单
		retreatArr: [],
		//将要平的多单
		plantArr: [],
		//将要平仓的多单
		nextTickAmount: [],
		//打印信息
		programInfo: [],
		connected: 0,
		error: 0,
		disconnected: 0,
		errorStr: '',

		cycleNum:900000,
		subKline:'ok_sub_futureusd_btc_kline_quarter_15min',
		kaiduoRate1:1.00201,
		kaiduoRate2:0.001,
		pingduoRate1:0.996,
		//pingduoRate1:0.99402,
		pingduoRate2:1.0014,
		deltaLimit:30000,
		delta:0,
		amount:8,
		changingAmount: 0,
		leverRate:20,

		origin:1.00201,


		curOrder:'',
		dueAmount:0,

		receiveTime:0,
		sendTime:0,


		allPlantArr:[],
		//移仓
		transArr:[],
		handleTransArr:[]






	},
	watch: {

	},
	computed: {
		objs: function(){
			var $this = this;
			var arr = [];
			arr.push($this.obj1)
			arr.push($this.obj2)
			arr.push($this.obj3)	
			return arr
		}

	},
	methods: {
		logError: function(str, funcName){
			var $this = this;
			var cur = $this.formatDate(new Date().getTime());
			
			if(window.localStorage.getItem('EMAError')===null){
				$this.strError = cur + ', ' + str + ', ' + funcName + '<br>';
			}else{
				var oldStr = window.localStorage.getItem('EMAError');
				$this.strError = oldStr + cur + ', ' + str + ', ' + funcName + '<br>';
			}
			window.localStorage.setItem("EMAError", $this.strError);
		},
		logInfo: function(str, funcName){
			var $this = this;
			var cur = $this.formatDate(new Date().getTime());
			
			if(window.localStorage.getItem('EMAInfo')===null){
				$this.strInfo = cur + ', ' + str + ', ' + funcName + '<br>';
			}else{
				var oldStr = window.localStorage.getItem('EMAInfo');
				$this.strInfo = oldStr + cur + ', ' + str + ', ' + funcName + '<br>';
			}
			window.localStorage.setItem("EMAInfo", $this.strInfo);
		},
		initEMA: function(arr){
			var $this = this;
			var len = arr.length;
			if(len<13){
				
				$this.logError("K线数据不足13", 'initEMA()')
				return;
			}
			var startY3=0, startY5=0, startY10=0;
			for(var i=0; i<3; i++){
				startY3 += arr[i][4]*(i+1)/6
			}
			for(var i=0; i<5; i++){
				startY5 += arr[i][4]*(i+1)/15
			}
			for(var i=0; i<10; i++){
				startY10 += arr[i][4]*(i+1)/55
			}

			var objs = [], obj1 = {}, obj2 = {}, obj3 = {};
			
			for(i=3; i<len; i++){
				startY3 = (2*arr[i][4]+(3-1)*startY3)/(3+1)
				if(i==len-3){
					startY3 = parseFloat(startY3.toFixed(2))
					obj1.timestamp = arr[i][0];
					obj1.price = arr[i][4];
					obj1.ema3 = startY3;
					obj1.formatTime = $this.formatDate(parseInt(obj1.timestamp));
					obj1.isValid = true;
				}else if(i==len-2){
					startY3 = parseFloat(startY3.toFixed(2))
					startY3 = parseFloat(startY3.toFixed(2))
					obj2.timestamp = arr[i][0];
					obj2.price = arr[i][4];
					obj2.ema3 = startY3;
					obj2.formatTime = $this.formatDate(parseInt(obj2.timestamp));
					obj2.isValid = true;
				}else if(i==len-1){
					startY3 = parseFloat(startY3.toFixed(2))
					startY3 = parseFloat(startY3.toFixed(2))
					obj3.timestamp = arr[i][0];
					obj3.price = arr[i][4];
					obj3.ema3 = startY3;
					obj3.formatTime = $this.formatDate(parseInt(obj3.timestamp));
				}
				//console.log("Y3" + "-" + $this.formatDate(parseInt(arr[i][0])) + ': ' + startY3)				
			}
			for(i=5; i<len; i++){
				startY5 = (2*arr[i][4]+(5-1)*startY5)/(5+1)
				if(i==len-3){
					startY5 = parseFloat(startY5.toFixed(2))
					obj1.ema5 = startY5
				}else if(i==len-2){
					startY5 = parseFloat(startY5.toFixed(2))
					obj2.ema5 = startY5
				}else if(i==len-1){
					startY5 = parseFloat(startY5.toFixed(2))
					obj3.ema5 = startY5
				}
				//console.log("Y5" + "-" + $this.formatDate(parseInt(arr[i][0])) + ': ' + startY5)
			}
			for(i=10; i<len; i++){
				startY10 = (2*arr[i][4]+(10-1)*startY10)/(10+1)
				if(i==len-3){
					//startY10 = parseFloat(startY10.toFixed(2))
					obj1.ema10 = startY10
				}else if(i==len-2){
					startY10 = parseFloat(startY10.toFixed(2))
					obj2.ema10 = startY10
				}else if(i==len-1){
					startY10 = parseFloat(startY10.toFixed(2))
					obj3.ema10 = startY10
				}
				//console.log("Y10" + "-" + $this.formatDate(parseInt(arr[i][0])) + ': ' + startY10)
			}
			$this.obj1 = obj1;
			$this.obj2 = obj2;
			$this.obj3 = obj3;

			//$this.objs = objs;
			localStorage.setItem("EMAdata", JSON.stringify($this.objs))
			
		},

		testspeed: function(){
			var $this = this;
			var curTime = new Date();
			$this.sendTime = curTime;
			$this.futureTrade(1000,1,1);
		},
		ensureAllOrder: function(){
			var $this = this;
			console.log("im checking lost orders...")

			$this.futureOrderInfo(-1);
		},
		formatStatus: function(s){
			var $this = this;
			switch(s){
				case 1: return "部分成交";
				break;
				case 2: return "全部成交";
				break;
				case 4: return "撤单处理中";
				break;
				case -1: return "撤单";
				break;
				case 0: return "等待成交";
				break;
				default:
				return '';
				break;
			}
		},
		formatDate: function(date){
			var d = new Date(date);
			return d.getFullYear()+"年"+(d.getMonth()+1)+"月"+d.getDate()+"日"+d.getHours()+":"+d.getMinutes()+":"+d.getSeconds();
		},
		start: function(){
			var $this = this;
			$this.okCoinWebSocket.init("wss://real.okex.com:10440/websocket/okexapi", "e4efd00c-64eb-49db-a010-9897ff89f61f", "");
			$this.startTime = new Date().getTime();

		},
		checkOrders: function(){
			var $this = this;

			//$this.futureOrderInfo(-1);
			for(var i=0; i<$this.allOrder.length; i++){
				//console.info("checkorders")
				//$this.reqCount++
				if($this.allOrder[i].type!=4){
					$this.futureOrderInfo($this.allOrder[i].order_id);
				}
				
			}
		},
		removeOrder: function(arr, id){
			var $this = this;
			for(var i=0; i<arr.length; i++){
				if(arr[i].order_id == id){
					var temp = arr[i]
					arr.splice(i, 1);
					return temp;
				}
			}
			return -1;
		},
		addOrder: function(arr, id, order){
			var $this = this;
			for(var i=0; i<arr.length; i++){
				if(arr[i].order_id == id){
					return;
				}
			}
			arr.push(order);
		},
		updateOrder: function(arr, id, order){
			var $this = this;
			for(var i=0; i<arr.length; i++){
				if(arr[i].order_id == id){
					var temp = arr[i]
					arr[i] = order;
					return temp;
				}
			}
			//如果没有查到
			//arr.push(order)
			return -1;
		},
		searchOrder: function(arr, id){
			var $this = this;
			for(var i=0; i<arr.length; i++){
				if(arr[i].order_id == id){
					return i;
				}
			}
			return -1;
		},
		search:function(arr,num){
			var $this = this;
			for(var i=0; i<arr.length; i++){
				if(arr[i] == num){
					return i;
				}
			}
			return -1;
		},
		decideYs: function(data){
			var $this = this;
			if(window.localStorage.getItem("EMAdata")===null){
				$this.initEMA(data);
			}else{
				var arr = JSON.parse(window.localStorage.getItem("EMAdata"))
				console.log("EMAdata form localStorage: "+JSON.stringify(arr))
				var obj = arr[1]
				if(obj.timestamp < data[0][0]-900000){
					window.localStorage.removeItem("EMAdata")
					$this.logInfo("缓存数据过时，清空ls的EMAdata","decideYs")
					$this.initEMA(data);
				}else{
					$this.alterEMA(data, obj);
				}
			}
		},
		alterEMA: function(data, obj){
			var $this = this;
			var startIndex = 0;
			for(var i=0; i<data.length; i++){
				if(obj.timestamp == data[i][0]-900000){
					startIndex = i;
					break;
				}
			}
			var len = data.length;
			var objs = JSON.parse(window.localStorage.getItem("EMAdata"))

			//一组K线数据最后一个元素正好是obj3,将ls的emadata直接还原即可
			if(startIndex == data.length-1){
				$this.obj1 = objs[0];
				$this.obj2 = objs[1];
				$this.obj3 = objs[2];
				console.log("一组K线数据最后一个元素正好是obj3,将ls的emadata直接还原即可")
				$this.logInfo("一组K线数据最后一个元素正好是obj3,将ls的emadata直接还原即可","alterEMA()")
				window.localStorage.setItem("EMAdata", JSON.stringify($this.objs))
				return;
			}else if(startIndex == data.length-2){
				$this.obj1 = objs[1]
				$this.obj2.timestamp = data[len-2][0]
				$this.obj2.price = data[len-2][4]
				$this.obj2.ema3 = $this.calema(data[len-2][4], 3, $this.obj1.ema3);
				$this.obj2.ema5 = $this.calema(data[len-2][4], 5, $this.obj1.ema5);
				$this.obj2.ema10 = $this.calema(data[len-2][4], 10, $this.obj1.ema10);
				$this.obj2.isValid = true;
				$this.obj2.formatTime = $this.formatDate( parseInt($this.obj2.timestamp) );
				$this.obj3 = {
					timestamp: data[len-1][0],
					price: data[len-1][4],
					formatTime: $this.formatDate( parseInt(data[len-1][0]) )
				}
				window.localStorage.setItem("EMAdata", JSON.stringify($this.objs))
				$this.logInfo("EMAdata落后这组K线1个周期","alterEMA()")
				return;

			}
			var y3;
			for(var i=startIndex; i<data.length; i++){
				//(2*data[i][4] + (3-1)*obj.ema3) / (3+1)
				obj.ema3 = $this.calema(data[i][4], 3, obj.ema3)
				obj.ema5 = $this.calema(data[i][4], 5, obj.ema5)
				obj.ema10 = $this.calema(data[i][4], 10, obj.ema10)
				if(i == data.length-3){
					$this.obj1.timestamp = data[len-3][0];
					$this.obj1.price = data[len-3][4];
					$this.obj1.ema3 = obj.ema3;
					$this.obj1.ema5 = obj.ema5;
					$this.obj1.ema10 = obj.ema10;
					$this.obj1.isValid = true;
					$this.obj1.formatTime = $this.formatDate( parseInt(data[i][0]) )
				}else if(i == data.length-2){
					$this.obj2.timestamp = data[len-2][0];
					$this.obj2.price = data[len-2][4];
					$this.obj2.ema3 = obj.ema3;
					$this.obj2.ema5 = obj.ema5;
					$this.obj2.ema10 = obj.ema10;
					$this.obj2.isValid = true;
					$this.obj2.formatTime = $this.formatDate( parseInt(data[i][0]) )
				}else if(i == data.length-1){
					$this.obj3.timestamp = data[len-1][0];
					$this.obj3.price = data[len-1][4];
					//$this.obj3.ema3 = obj.ema3;
					//$this.obj3.ema5 = obj.ema5;
					//$this.obj3.ema10 = obj.ema10;
					//$this.obj3.isValid = true;
					$this.obj3.formatTime = $this.formatDate( parseInt(data[i][0]) )
				}else{
					continue;
				}
			}
			$this.logInfo("EMAdata落后这组K线1个周期以上","alterEMA()")
			window.localStorage.setItem("EMAdata", JSON.stringify($this.objs))


		},
		calema: function(p, n, y){
			var $this= this;
			var num = parseFloat(((2*p + (n-1)*y)/(n+1)).toFixed(2))
			return num;
		},
		checkStatus: function(){
			var $this = this;
		},
		onMessage: function(e) {
			var $this = this;
			//$this.recCount++;
			//console.log($this.formatDate(new Date().getTime()) + ": " + e.data)
			var array = JSON.parse(e.data);
			//msg为除了pong以外的数据消息
			if(array.length==1){
				var msg = array[0];
				if(msg){
					if(msg['channel']=="ok_sub_futureusd_btc_kline_quarter_15min"){
						console.log($this.formatDate(new Date().getTime()) + ": " + e.data)
						if(msg['data'].length>1){
							$this.decideYs(msg.data);
							
						}else{
							var data = msg['data'][0];

							if($this.obj3.timestamp == data[0]-900000){
								$this.obj1 = $this.obj2;
								$this.obj2 = $this.obj3;
								$this.obj2.isValid = true;
								$this.checkStatus();
								$this.obj3 = {
									timestamp: data[0],
									price: data[4],
									formatTime: $this.formatDate( parseInt(data[0]) )

								}
								window.localStorage.setItem("EMAdata", JSON.stringify($this.objs))
								console.log("set data .............................")
							}else if($this.obj3.timestamp == data[0]){
								$this.obj3.price = data[4];
								$this.obj3.ema3 = $this.calema(data[4], 3, $this.obj2.ema3)
								$this.obj3.ema5 = $this.calema(data[4], 5, $this.obj2.ema5)
								$this.obj3.ema10 = $this.calema(data[4], 10, $this.obj2.ema10)
							}else{
								$this.logError( "obj3时间："+$this.obj3.timestamp+"错误，新来的K线数据时间："+$this.formatDate(parseInt(data[0])), "ok_sub_futureusd_btc_kline_quarter_15min" )
							}

							if($this.cur15minTime < data[0]){
								console.info($this.cur15minTime+","+data[0])
							
								$this.cur15minTime = data[0];
								
							}
						}
						
						
						
						


					}
					else if(msg['channel']=="ok_futureusd_orderinfo"){
						//console.info("okinfo come in")
						if(msg['data'].result&&msg['data'].result!='false'){
							for(var i=0; i<msg['data'].orders.length; i++){
								var order = msg['data'].orders[i];
								
								if(order.lever_rate!=10){
									continue;
								}
								if(order.symbol=='ltc_usd'){
									continue;
								}
								
								

							}
						}
					}
					else if(msg['channel']=="ok_futureusd_trade"){

						if(msg['data'].result&&msg['data'].result!='false'){
							
							var time = new Date().getTime()
							$this.receiveTime = time;
							var order = {
								order_id: msg['data'].order_id,
								order_time: time-time%$this.cycleNum
							}

							$this.allOrder.push(order);
							//$this.proxyingArr.push(order);
							
						}
					}else if(msg['channel']=='ok_futureusd_cancel_order'){

						if(msg['data'].result&&msg['data'].result!='false'){
							var id = msg['data'].order_id;


							
							$this.removeOrder($this.retreatArr,id);

							
						}
					}else if(msg['channel']=="ok_sub_futureusd_positions"){
						if(msg['data']['symbol']=='btc_usd'){
							var positionArr = msg['data']['positions']
							var dAmount = 0;
							var kAmount = 0;  
							for(var i in positionArr){
								if(positionArr[i]['position']=='1'&&positionArr[i]['lever_rate']==20){
									console.info("dudaole position in array0")
									dAmount += parseFloat(positionArr[i]['hold_amount']);
								}else if(positionArr[i]['position']=='2'&&positionArr[i]['lever_rate']==20){
									kAmount += parseFloat(positionArr[i]['hold_amount']);
								}
							}
							var delta = dAmount - kAmount;
							var max = dAmount - kAmount > 0 ? dAmount : kAmount;
							var sum = dAmount+kAmount;


							
							
							

							

						}
						

					}
				}
			}else{
				var msg = array;
				for(var i in msg){
					if(msg[i]['channel']=="ok_sub_futureusd_positions"){
						if(msg[i]['data']['symbol']=='btc_usd'){
							var positionArr = msg[i]['data']['positions']
							var dAmount=0;
							var kAmount=0
							for(var i in positionArr){
								
								if(positionArr[i]['position']=='1'&&positionArr[i]['lever_rate']==20){
									console.info("dudaole position in ARRAY")
									dAmount += parseFloat(positionArr[i]['hold_amount']);
									console.log("dAmount:"+dAmount)
								}else if(positionArr[i]['position']=='2'&&positionArr[i]['lever_rate']==20){
									kAmount += parseFloat(positionArr[i]['hold_amount']);
								}
								
							}
							var delta = dAmount - kAmount;
							var max = dAmount - kAmount > 0 ? dAmount : kAmount;
							var sum = dAmount+kAmount;



						}
						

					}
				}
			}
			



			if(array.event == 'pong') {
				$this.okCoinWebSocket.lastHeartBeat = new Date().getTime();
			} else {
				//$this.createTable(array);
			}
		},

		showOrder1: function(){
			var $this =  this;
			//$this.futureOrderInfo(-1);
			//this.futureTrade();
		},
		retreat: function(){
			var $this = this;
			
			for(var i=0; i<$this.retreatArr.length; i++){
				$this.futureCancelOrder($this.retreatArr[i].order_id);
			}

		},
		makeorder: function(){
			var $this = this;

			var price1 = parseFloat(($this.kaipan15min * $this.kaiduoRate1).toFixed(2));

			$this.futureTrade(price1,2,$this.amount);

			

		},


		print: function(message) {
			var status = document.getElementById("status");
			status.style.wordWrap = "break-word";
			status.innerHTML += message + "<br/>";
		},
		doSend: function(message) {
			var $this = this;
			//$this.sendCount++;
			//$this.print("SENT: " + message);
			if($this.okCoinWebSocket){
				var ws = $this.okCoinWebSocket.websocket
				this.send = function (message, callback) {
				    this.waitForConnection(function () {
				        ws.send(message);
				        if (typeof callback !== 'undefined') {
				          callback();
				        }
				    }, 100);
				};

				this.waitForConnection = function (callback, interval) {
				    if (ws.readyState === 1) {
				        callback();
				    } else {
				        var that = this;
				        // optional: implement backoff for interval here
				        setTimeout(function () {
				            that.waitForConnection(callback, interval);
				        }, interval);
				    }
				};


				this.send(message);
			}
			
			
		},
		onOpen: function(evt) {
			var $this = this;
			//$this.print("CONNECTED");
			$this.connected++;
			var str = "{'event':'addChannel','channel':'ok_sub_futureusd_btc_kline_quarter_15min'}"
			console.info(str);
			$this.doSend(str);
			//现货交易、合约交易测试
			//tradeTest();
			$this.futurePositions();
			
		},
		createTable: function(array) {
			var $this = this;
			var str = '<table id="tdata" border="1">\r\n<tr id="tr0">\r\n';
			for ( var index in array[0]) {
				str += '<th>' + index + '</th>\r\n';
			}
			str += '</tr>\r\n';

			for ( var i = 0; i < array.length; i++) {
				str += '<tr id="tr' + (i+1) + '">\r\n';
				for ( var j in array[i]) {
					str += '<td>' + JSON.stringify(array[i][j]) + '</td>\r\n';
					//if(typeof array[i][j] == 'string' && array[i][j].indexOf("ok_") >= 0) {
						//console.log(array[i][j]);
					//}
				}
				str += '</tr>\r\n';
			}
			
			str += '</table>\r\n';
			document.getElementById("output").innerHTML = str;
		},
		finishOrder: function(order){
			var $this = this;
			
			//$this.finishArr.push(order);
		},
		
		onError: function(evt) {
			var $this = this;
			//$this.print('<span style="color: red;">ERROR:</span> ' + evt.data);
			$this.error++;
			$this.errorStr += error+'. '+evt.data;


		},
		onClose: function(evt) {
			var $this = this;
			//print("DISCONNECTED");
			$this.disconnected++;
		},
		checkConnect: function () {
			var $this = this;
			var ws = $this.okCoinWebSocket.websocket
			this.send = function (message, callback) {
			    this.waitForConnection(function () {
			        ws.send(message);
			        if (typeof callback !== 'undefined') {
			          callback();
			        }
			    }, 100);
			};

			this.waitForConnection = function (callback, interval) {
			    if (ws.readyState === 1) {
			        callback();
			    } else {
			        var that = this;
			        // optional: implement backoff for interval here
			        setTimeout(function () {
			            that.waitForConnection(callback, interval);
			        }, interval);
			    }
			};


			this.send("{'event':'ping'}");
			
			if ((new Date().getTime() - $this.okCoinWebSocket.lastHeartBeat) > $this.okCoinWebSocket.overtime) {
				console.log("socket 连接断开，正在尝试重新建立连接");
				//testWebSocket();
				$this.okCoinWebSocket.init("wss://real.okex.com:10440/websocket/okexapi", "e4efd00c-64eb-49db-a010-9897ff89f61f", "");

			}
		},
		futureOrderInfo: function(orderId) {
			//-1表示未完成订单
			//console.info("i am querying info")
			var $this = this;
			var okCoinWebSocket = $this.okCoinWebSocket;
			/*var str = "api_key=" + okCoinWebSocket.api_key + "&contract_type=quarter&current_page=1&order_id=" + orderId + "&page_length=1&secret_key=" + okCoinWebSocket.secret_key + "&status=1&symbol=btc_usd"*/
			var str = "api_key=" + okCoinWebSocket.api_key + "&contract_type=quarter&current_page=1&order_id=" + orderId + "&page_length=50&status=1&symbol=btc_usd&secret_key=" + okCoinWebSocket.secret_key

			var sign = MD5(str);
			$this.doSend("{'event': 'addChannel','channel': 'ok_futureusd_orderinfo','parameters': {'api_key': '"
					+ okCoinWebSocket.api_key + "','sign': '" + sign + "','symbol': 'btc_usd','order_id': '" + orderId
					+ "','contract_type': 'quarter','status':'1','current_page':'1','page_length':'50'}}");
					
		},
		//合约下单
		futureTrade: function (price,type,amount) {
			var $this = this;
			var lv = $this.leverRate;
			
			$this.sendTime = new Date()
			var okCoinWebSocket = $this.okCoinWebSocket;
			var str = "amount="+ amount +"&api_key=" + okCoinWebSocket.api_key + 
					"&contract_type=quarter&lever_rate="+lv+"&match_price=0&price=" + price + "&symbol=btc_usd&type="+ type +"&secret_key=" + okCoinWebSocket.secret_key
	
			var sign = MD5(str);
			$this.doSend("{'event': 'addChannel','channel':'ok_futureusd_trade','parameters': {'api_key': '"+ okCoinWebSocket.api_key + "','sign': '" + sign + "','symbol': 'btc_usd','contract_type': 'quarter','amount': "+ amount +",'price': "+price+",'type': "+type+",'match_price': '0','lever_rate':" +lv+"}}");
			
		},
		//撤单
		futureCancelOrder: function(orderId) {
			var $this = this;
			var okCoinWebSocket = $this.okCoinWebSocket;
			var sign = MD5("api_key=" + okCoinWebSocket.api_key + "&contract_type=quarter&order_id=" + orderId
					+ "&symbol=btc_usd&secret_key=" + okCoinWebSocket.secret_key);
			$this.doSend("{'event': 'addChannel','channel': 'ok_futureusd_cancel_order','parameters': {'api_key': '"
					+ okCoinWebSocket.api_key + "','sign': '" + sign + "','symbol': 'btc_usd','order_id': '" + orderId
					+ "','contract_type': 'quarter'}}");
		},
		futurePositions: function() {
			var $this = this;
			var okCoinWebSocket = $this.okCoinWebSocket;
			var sign = MD5("api_key=" + okCoinWebSocket.api_key + "&secret_key=" + okCoinWebSocket.secret_key);
			$this.doSend("{'event':'addChannel','channel':'ok_sub_futureusd_positions','parameters' :{'api_key':'"
					+ okCoinWebSocket.api_key + "','sign':'" + sign + "'}}");
		},
		setData: function(){
			var $this = this;
			var ls = window.localStorage;
			/*if(ls.getItem('EMAError')!==null){
				$this.strError = ls['EMAError'];
			}*/

		}
			
	
			
	},
	mounted() {
		var $this = this;
		$this.setData();
		$this.okCoinWebSocket.init = function(uri, apiKey, secretKey) {
			this.wsUri = uri;
			this.api_key = apiKey;
			this.secret_key = secretKey;
			this.lastHeartBeat = new Date().getTime();
			this.overtime = 8000;
			var okCoinWebSocket = $this.okCoinWebSocket;
			
			okCoinWebSocket.websocket = new WebSocket(okCoinWebSocket.wsUri);
			
			okCoinWebSocket.websocket.onopen = function(evt) {
				$this.onOpen(evt)
			};
			okCoinWebSocket.websocket.onclose = function(evt) {
				$this.onClose(evt)
			};
			okCoinWebSocket.websocket.onmessage = function(evt) {
				$this.onMessage(evt)
			};
			okCoinWebSocket.websocket.onerror = function(evt) {
				$this.onError(evt)
			};
			
			setInterval($this.checkConnect,2000);
			
			setInterval($this.checkOrders,800);

			//尝试从撤单队列撤单
			setInterval($this.retreat,200);

			setInterval($this.ensureAllOrder,10000);


			var cur = new Date().getTime();
			var random = cur%1000*1000+500000
			//0~999s 5001000~1499000
			if(random<900000){
				random = 950000
			}


			setInterval(function(){
				var curTime = new Date().getTime();
				if($this.cycleNum-curTime%$this.cycleNum<20000||curTime%$this.cycleNum<20000){
					return;
				}
				if(curTime-$this.cur15minTime>$this.cycleNum){
					location.reload();
				}else{
					return;
				}
				
				
			},random)
		}

		$this.start();

		
				
	}
})
</script>
</html>