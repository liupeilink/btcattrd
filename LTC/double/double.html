<!DOCTYPE html>
<!-- //md5加密 按字母顺序，secretkey放在最后 -->
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>LTC</title>
	<style>
		th {background: #ccc;}
		table td,table th{
			font-size:14px;
			font-weight: 400;
			text-align: center;
			width:12%;
		}
		table {width:800px; border:1px solid #666; margin-bottom: 30px; max-height:200px; overflow: scroll;}

	</style>
</head>
<body>
	<div id="app">
		<button @click="start">启动</button>
		<button @click="futureTrade(1000,1,1)">下单</button>
		<button @click="futureCancelOrder(6465769535)">撤xxx</button>


		{{receiveTime - sendTime}}
		<p>direction: {{ltcDirection}}</p>
		
		<p v-if="ltcDirection=='d'">CloseLongRate:<span style="color:#33f"> {{CloseLongRate}}</span></p>
		<p v-if="ltcDirection=='k'">CloseShortRate: <span style="color:#33f">{{CloseShortRate}}</span></p>
		<p v-if="ltcDirection=='d'">当前多仓止损rate是zhiduorate: <span style="color:red">{{zhiDuoRate}}</span></p>
		<p v-if="ltcDirection=='k'">当前空仓止损rate是zhikongrate:<span style="color:red"> {{zhiKongRate}}</span></p>
		<p>提示：{{someTips}}</p>
		<br>
		<p>hasLost: {{getHasLost()}}</p>	
		<p>step: {{step}}(1.开仓成功。2，平单等待成交。3.发生了撤单，因为止损，已经撤单成功。4.平单完全成交（止盈单或者止损单）)</p>
		<br>
		<p>ltcAmount: {{ltcAmount}}</p>
		<p>originltcAmount: {{originltcAmount}}</p>
		<br>
		<p>平单委托价格curPlantOrder.price: {{curPlantOrder.price}}</p>
		<p>平单止损价格StopPrice: {{StopPrice}}</p>
	<!-- 	<p>curPlantOrder.order_id: {{curPlantOrder.order_id}}</p> -->
		<p>平单创建日期curPlantOrder.create_date: {{formatDate(curPlantOrder.create_date)}}</p>
		

		

		<p>allOrder (只遍历非平单)</p>
		<table id="processing">
			<tr>
				<th>订单号</th><th>cycle时间</th>
			</tr>
			<tr v-for="item in allOrder">
				<td>{{item['order_id']}}</td>				
				<td>{{formatDate(item.order_time)}}</td>

			</tr>
		</table>
		<div>
			<p v-if="startTime">
				系统启动时间：{{formatDate(startTime)}}
			</p>
		</div>
		<div id="status">
			<p v-if="connected>0">CONNECTED:+{{connected}}</p>
			<p v-if="error>0">ERROR:+{{error}} {{errorStr}}</p>
			<p v-if="disconnected>0">DISCONNECTED:+{{disconnected}}</p>
		</div>
		<div id="output"></div>
	</div>
</body>
<script type="text/javascript" src="MD5.js"></script>
<script src="../jquery-3.2.1.js"></script>
<script src="../vue.js"></script>
<script>
var app = new Vue({
	el:"#app",
	data: {
		
		okCoinWebSocket:{},

		someTips:'',
		zhisunTimer:'',
		zhisunOrder:'',
		tickerData:{},
		tickerOrder:'',
		curPlantOrder:'',
		tickerPosition:'',
		ltcBond:-1,
		ltcDirection:"d",// "d"&"k"
		curltcSell:'',
		curltcBuy:'',
		ltcAmount:2,
		originltcAmount:2,
		stop:false,
		CloseLongRate: 1.002,
		originlongrate: 1.002,
		CloseShortRate: 0.998,
		originshortrate: 0.998,
		kaiPrice:'',
		StopPrice:'',
		zhiDuoRate: 0.998,
		originzhiduorate:0.998,
		zhiKongRate: 1.002,
		originzhikongrate:1.002,
		step:0,
		cancelSuc:'',
		remain:'',
		zaiCancelZhongXialeZhisun:'',
		saveRemain:'',
		realzhisunPrice:'',
		realzhisunAmount:'',

		



		curTime: '',

		//开多订单库
		proxyingArr: [],
		//正在请求中的开多订单库
		proxyingArr1: [],
		//平多订单库
		sellingArr:[],

		//当前kline开盘价
		kaipan15min:'',
		//当前cycle的时间戳，与开盘价一同更新
		cur15minTime:'',
		
		
		//所有未完成订单 {order_id:'',seq:''}
		allOrder:[],
		//所有已完成、未完成订单 
		finishArr: [],
		unfinishArr: [],
		//系统启动时间
		startTime: '',
		//将要撤单的订单
		retreatArr: [],
		//将要平的多单
		plantArr: [],
		//将要平仓的多单
		nextTickAmount: [],
		//打印信息
		programInfo: [],
		connected: 0,
		error: 0,
		disconnected: 0,
		errorStr: '',




		cycleNum:300000,
		subKline:'ok_sub_futureusd_btc_kline_quarter_5min',
		kaiduoRate1:0.99802,
		kaiduoRate2:0.001,
		pingduoRate1:1.00198,
		pingduoRate2:1.0014,
		deltaLimit:30000,
		delta:0,
		amount:8,
		changingAmount: [],
		leverRate:20,

		origin:0.99802,


		curOrder:'',
		dueAmount:0,

		receiveTime:0,
		sendTime:0,

		amountArr:[7,6,5,4],
		originArr:[7,6,5,4],
		fazhi:[3000,2500,2000],







	},


	methods: {
		getHasLost:function(){
			if(window.localStorage.getItem("hasLost")===null){
				return "缓存中没有hasLost,崭新的系统还没有过亏损（止损单）"
			}else if(window.localStorage.getItem("hasLost")==='0'){
				return "0"
			}else{
				return window.localStorage.getItem("hasLost")
			}
		},
		tradeLTC: function(data){
			var $this = this;
			var dir = $this.ltcDirection;
			var basePrice;
			var givePrice;
			var type=-1;
			if(dir=='d'){
				basePrice = data.sell;
				givePrice = basePrice*1.005
				type = 1;

			}else if(dir=='k'){
				basePrice = data.buy;
				givePrice = basePrice*0.995
				type = 2;
			}else{
				console.log("error:dir is "+dir)
			}

			//如果缓存中有不为0的ltcAmount，那么它是真实的ltcAmount
			var lsltcAmount = window.localStorage.getItem("ltcAmount");
			if(lsltcAmount!==null && lsltcAmount!=='0'){
				$this.ltcAmount = parseFloat(lsltcAmount); 
			}
			
			$this.futureTrade(givePrice,type,$this.ltcAmount);
		},
		
		

		ensureAllOrder: function(){
			var $this = this;
			console.log("im checking lost orders...")



			$this.futureOrderInfo(-1);
		},
		formatStatus: function(s){
			var $this = this;
			switch(s){
				case 1: return "部分成交";
				break;
				case 2: return "全部成交";
				break;
				case 4: return "撤单处理中";
				break;
				case -1: return "撤单";
				break;
				case 0: return "等待成交";
				break;
				default:
				return '';
				break;
			}
		},
		formatDate: function(date){
			var d = new Date(date);
			return d.getFullYear()+"年"+(d.getMonth()+1)+"月"+d.getDate()+"日"+d.getHours()+":"+d.getMinutes()+":"+d.getSeconds();
		},

		start: function(){
			var $this = this;
			$this.okCoinWebSocket.init("wss://real.okex.com:10440/websocket/okexapi", "0b8d2c87-cd53-4458-8a6a-ef7363a744fe", "DE9F7E166BD6ABED472C2B5FC21C4C29");
			$this.startTime = new Date().getTime();
		},

		checkOrders: function(){
			var $this = this;

			for(var i=0; i<$this.allOrder.length; i++){
				
				$this.futureOrderInfo($this.allOrder[i].order_id);				
				
			}
		},
		removeOrder: function(arr, id){
			var $this = this;
			for(var i=0; i<arr.length; i++){
				if(arr[i].order_id == id){
					var temp = arr[i]
					arr.splice(i, 1);
					return temp;
				}
			}
			return -1;
		},
		addOrder: function(arr, id, order){
			var $this = this;
			for(var i=0; i<arr.length; i++){
				if(arr[i].order_id == id){
					return;
				}
			}
			arr.push(order);
		},
		updateOrder: function(arr, id, order){
			var $this = this;
			for(var i=0; i<arr.length; i++){
				if(arr[i].order_id == id){
					var temp = arr[i]
					arr[i] = order;
					return temp;
				}
			}
			//如果没有查到
			//arr.push(order)
			return -1;
		},
		searchOrder: function(arr, id){
			var $this = this;
			for(var i=0; i<arr.length; i++){
				if(arr[i].order_id == id){
					return i;
				}
			}
			return -1;
		},
		search:function(arr,num){
			var $this = this;
			for(var i=0; i<arr.length; i++){
				if(arr[i] == num){
					return i;
				}
			}
			return -1;
		},
		computeLost:function(){
			var $this = this;
			if($this.kaiPrice==''){
				$this.kaiPrice = parseFloat(window.localStorage.getItem("kaiPrice"))
			}
			var kaiprice = $this.kaiPrice;
			var pingprice;
			var zsprice = $this.realzhisunPrice;
			var amount = $this.ltcAmount;
			var remain = $this.saveRemain;
			if(remain===''){
				remain = 0;
			}

			if($this.ltcDirection=='d'){
				pingprice = parseFloat((kaiprice * $this.CloseLongRate).toFixed(3));
				var usd1 = (pingprice - kaiprice)*(amount-remain)*10/kaiprice;//正数
				var usd2 = (zsprice-kaiprice)*(remain*10)/kaiprice;//负数
				
			}else if($this.ltcDirection=='k'){
				pingprice = parseFloat((kaiprice * $this.CloseShortRate).toFixed(3));
				var usd1 = -(pingprice - kaiprice)*(amount-remain)*10/kaiprice;//正数
				var usd2 = -(zsprice-kaiprice)*(remain*10)/kaiprice;//负数

			}
			var usd = usd1 + usd2;//不一定是正的还是负的
			var bit = usd1/pingprice + usd2/zsprice;//不一定是正的还是负的
			
			if(window.localStorage.getItem("hasLost")===null){
				window.localStorage.setItem("hasLost",String(bit));
			}else{
				var prelost = parseFloat(window.localStorage.getItem("hasLost"));
				var l = prelost + bit;
				window.localStorage.setItem("hasLost",String(l));

			}
			

		},
		computeShouldRate:function(price_avg){
			var $this = this;
			if(window.localStorage.getItem("hasLost")===null){
				return;
			}else if(window.localStorage.getItem("hasLost")==='0'){
				return;
			}
			var hasLost = parseFloat(window.localStorage.getItem("hasLost"));
			if(hasLost>0){
				var curTime = new Date().getTime();
				$this.someTips = "虽然上次发生了止损，但是收益已经补回了前面所有损失，收益是："+hasLost+ ' ' +$this.formatDate(curTime) ;
				return;
			}
			var r = $this.ltcAmount/$this.originltcAmount;
			var cancelTime = Math.log(r)*Math.LOG2E
			var desRate = 2-Math.sqrt(cancelTime)/5

			var destination = -hasLost*desRate;
			var ltcAmount = $this.ltcAmount;
			if($this.ltcDirection=='d'){
				var duorate;
				//$this.ltcAmount*100/price_avg*(price_avg*duorate-price_avg)/price_avg*duorate=destination
				duorate = 10*ltcAmount/(10*ltcAmount - price_avg*destination );
				$this.CloseLongRate = duorate;
				window.localStorage.setItem("CloseLongRate",String(duorate))
				$this.zhiDuoRate = 1-(duorate-1);
				window.localStorage.setItem("zhiDuoRate",String($this.zhiDuoRate))



			}else if($this.ltcDirection=='k'){
				var kongrate;
				//$this.ltcAmount*100/price_avg*(price_avg*duorate-price_avg)/price_avg*duorate=destination
				kongrate = 10*ltcAmount/(10*ltcAmount + price_avg*destination );
				$this.CloseShortRate = kongrate;
				window.localStorage.setItem("CloseShortRate",String(kongrate))
				$this.zhiKongRate = 1-kongrate+1;
				window.localStorage.setItem("zhiKongRate",String($this.zhiKongRate))
			}

		},
		onMessage: function(e) {
			var $this = this;
			//$this.recCount++;
			console.log($this.formatDate(new Date().getTime()) + ": " + e.data)
			var array = JSON.parse(e.data);
			//msg为除了pong以外的数据消息
			if(array.length==1){
				var msg = array[0];
				if(msg){

					if(msg['channel']=="ok_futureusd_orderinfo"){
						console.info("okinfo come in")
						if(msg['data'].result&&msg['data'].result!='false'){
							for(var i=0; i<msg['data'].orders.length; i++){
								var order = msg['data'].orders[i];
								
								if(order.symbol == 'btc_usd'){
									continue;
								}

								
								if($this.searchOrder($this.allOrder, order.order_id) == -1 && order.status!=2){
									//只要有lostorder就加进allOrder，剩下的事情交给allorder去做
									$this.addOrder($this.allOrder, order.order_id, order)
								}

								//开单处理 特性：一次性成交
								if(order.type==1 || order.type==2){
									if($this.tickerOrder==''){
										$this.tickerOrder = order;
										
									}else{
										if(order.create_date>$this.tickerOrder.create_date){
											$this.tickerOrder = order;	
										}
									}

									if(order.status == 2){
										$this.kaiPrice = order.price_avg;
										window.localStorage.setItem("kaiPrice", String(order.price_avg))
										$this.step = 1;
										$this.computeShouldRate(order.price_avg);

										//...................................handle ls
										var lsCloseLongRate = window.localStorage.getItem("CloseLongRate")
										var lsCloseShortRate = window.localStorage.getItem("CloseShortRate")
										var lszhiDuoRate = window.localStorage.getItem("zhiDuoRate")
										var lszhiKongRate = window.localStorage.getItem("zhiKongRate")
										if(lsCloseLongRate!==null && parseFloat(lsCloseLongRate)!==$this.originlongrate){
											$this.CloseLongRate = parseFloat(lsCloseLongRate);
										}
										if(lsCloseShortRate!==null && parseFloat(lsCloseShortRate)!==$this.originshortrate){
											$this.CloseShortRate = parseFloat(lsCloseShortRate);
										}
										if(lszhiDuoRate!==null && parseFloat(lszhiDuoRate)!==$this.originzhiduorate){
											$this.zhiDuoRate = parseFloat(lszhiDuoRate);
										}
										if(lszhiKongRate!==null && parseFloat(lszhiKongRate)!==$this.originzhikongrate){
											$this.zhiKongRate = parseFloat(lszhiKongRate);
										}
										//handle ls over................................


										if(order.type==1){
											var p = parseFloat((order.price_avg * $this.CloseLongRate).toFixed(3));
											$this.futureTrade(p, 3, order.deal_amount);
											$this.StopPrice = parseFloat((order.price_avg * $this.zhiDuoRate).toFixed(3));
										}else if(order.type==2){
											var p = parseFloat((order.price_avg * $this.CloseShortRate).toFixed(3));
											$this.futureTrade(p, 4, order.deal_amount);
											$this.StopPrice = parseFloat((order.price_avg * $this.zhiKongRate).toFixed(3));
										}
										window.localStorage.setItem("StopPrice", String($this.StopPrice));
										$this.removeOrder($this.allOrder,order.order_id)
									}
								}

								//平单处理， 特性：止盈单不一定一次性成交，止损单一次性成交
								if(order.type==3 || order.type==4){

									if($this.curPlantOrder == ''){
										$this.curPlantOrder = order;
										
									}else{
										if(order.create_date>$this.curPlantOrder.create_date){
											$this.curPlantOrder = order;
										}
									}
									if($this.StopPrice===''){
										//刷新后没有这个price
										$this.StopPrice = parseFloat(window.localStorage.getItem("StopPrice"));
									}
									

									if(order.status==0 || order.status==1){
										$this.step = 2;
									}
									if(order.status==1||order.status==0){
										$this.remain = order.amount-order.deal_amount;
										window.localStorage.setItem("remain",String($this.remain))
									}
									if(order.status==2){

										$this.step = 4;

										console.log("step 4 is "+$this.step);

										if($this.zaiCancelZhongXialeZhisun===true){
											
											$this.realzhisunPrice = order.price_avg;

											$this.computeLost();

											$this.realzhisunAmount = order.deal_amount;
											var lastAmount = $this.ltcAmount;
											
											if($this.ltcAmount>=128*$this.originltcAmount){

												$this.ltcAmount = $this.originltcAmount
												
												var l = window.localStorage.getItem("hasLost")
												var hb;
												if(window.localStorage.getItem("heartbreakLost")===null){
													window.localStorage.setItem("heartbreakLost", l);
												}else{
													hb = window.localStorage.getItem("heartbreakLost")
													hb = hb + ', ' + l;
													window.localStorage.setItem("heartbreakLost", hb)
												}
												
												window.localStorage.setItem("hasLost",'0');
												window.localStorage.setItem("zhiDuoRate",String($this.originzhiduorate))
												$this.zhiDuoRate = $this.originzhiduorate;
												window.localStorage.setItem("zhiKongRate",String($this.originzhikongrate))
												$this.zhiKongRate = $this.originzhikongrate;
												window.localStorage.setItem("CloseShortRate",String($this.originshortrate))
												$this.CloseShortRate = $this.originshortrate;
												window.localStorage.setItem("CloseLongRate",String($this.originlongrate))
												$this.CloseLongRate = $this.originlongrate;
											}else{
												$this.ltcAmount = $this.ltcAmount*2;
											}
											
											window.localStorage.setItem("ltcAmount",String($this.ltcAmount))
											
											order.type==3 ? $this.ltcDirection = 'k' : $this.ltcDirection = 'd'; 
											window.localStorage.setItem("ltcDirection",$this.ltcDirection)

											
											var hasLost = parseFloat(window.localStorage.getItem("hasLost"))
											$this.hasLost = hasLost;

											$this.zaiCancelZhongXialeZhisun = false;
											

										}else{
											if(window.localStorage.getItem("hasLost")!==null){
												window.localStorage.setItem("hasLost",'0');
											}
											
											$this.hasLost = 0;
											//window.localStorage.setItem("hasLost",'0');
											
											$this.ltcAmount = $this.originltcAmount ;
											window.localStorage.setItem("ltcAmount",String($this.ltcAmount))
											
											$this.CloseLongRate = $this.originlongrate;
											window.localStorage.setItem("CloseLongRate",String($this.originlongrate))
											
											$this.CloseShortRate = $this.originshortrate;
											window.localStorage.setItem("CloseShortRate",String($this.originshortrate))
											
											$this.zhiDuoRate = $this.originzhiduorate;
											window.localStorage.setItem("zhiDuoRate",String($this.zhiDuoRate))
											
											$this.zhiKongRate = $this.originzhikongrate;
											window.localStorage.setItem("zhiKongRate",String($this.zhiKongRate))
											
											order.type==3 ? $this.ltcDirection = 'd' : $this.ltcDirection = 'k';
											window.localStorage.setItem("ltcDirection",$this.ltcDirection)

											window.localStorage.setItem("StopPrice",'');
											$this.StopPrice = '';

											$this.remain = '';
											window.localStorage.setItem("remain",String($this.remain))
										}
										
										$this.step = 0;
										$this.tickerOrder = '';
										//$this.futureUserInfo();

										/*if($this.stop==true){
											//止损单
											order.type==3 ? $this.ltcDirection = 'k' : $this.ltcDirection = 'd'; 
										}else{
											order.type==3 ? $this.ltcDirection = 'd' : $this.ltcDirection = 'k';
										}*/
										$this.removeOrder($this.allOrder,order.order_id)
									}
								}

								
								
/*
								if(order.status==2){

									//移出系统遍历队列
									$this.removeOrder($this.allOrder,order.order_id)
									$this.removeOrder($this.unfinishArr,order.order_id)
									//加入完成队列
									//$this.addOrder($this.finishArr,order.order_id,order);
									if(order.type==1){


										//尝试去卖？

										//所开多单全部成交，去平多单,
										if($this.updateOrder($this.nextTickAmount,order.order_id,order)==-1){
											$this.addOrder($this.nextTickAmount,order.order_id,order)
										}
									}

								}else{
									//未完全成交
									if($this.updateOrder($this.unfinishArr,order.order_id,order)==-1){
										$this.addOrder($this.unfinishArr,order.order_id,order)
									}
									var curTime = new Date().getTime();
									//未完全成交的多单
									if((order.status==0 || order.status==1) && order.type==1){
										//超时未完全成交的多单
										var cycleTime = order.create_date-order.create_date%$this.cycleNum
										if(cycleTime+$this.cycleNum<curTime){
											//预备撤单
											$this.dueAmount = 0;
											$this.addOrder($this.retreatArr,order.order_id,order);
										}
										if(order.deal_amount>0){
										//有所成交
											if($this.updateOrder($this.nextTickAmount,order.order_id,order)==-1){
												$this.addOrder($this.nextTickAmount,order.order_id,order)
											}
										}
										
										
									}
									//已经撤单
									if(order.status==-1){
										if(order.deal_amount>0){
										//有所成交
											if($this.updateOrder($this.nextTickAmount,order.order_id,order)==-1){
												$this.addOrder($this.nextTickAmount,order.order_id,order)
											}
										}
										//移出系统遍历队列
										$this.removeOrder($this.allOrder,order.order_id)
										$this.removeOrder($this.unfinishArr,order.order_id)
										
									}
								}*/
								
								

							}
						}
					}
					else if(msg['channel']=="ok_futureusd_trade"){

						if(msg['data'].result&&msg['data'].result!='false'){
							if($this.zhisunTimer!==''){
								clearInterval($this.zhisunTimer);
								$this.zhisunTimer = '';
							}
							
							$this.zhisunOrder = '';

							var time = new Date().getTime()
							$this.receiveTime = time;
							var order = {
								order_id: msg['data'].order_id,
								order_time: time
							}

							$this.allOrder.push(order);
							//$this.proxyingArr.push(order);
							
						}else{
							if($this.zhisunOrder!==''){
								var o = $this.zhisunOrder;
								$this.zhisunTimer = setInterval(function(){
									$this.futureTrade(o.price, o.type, o.amount);
								},150);
							}
							
						}
					}else if(msg['channel']=='ok_futureusd_cancel_order'){

						if(msg['data'].result&&msg['data'].result!='false'){
							var id = msg['data'].order_id;
							$this.cancelSuc = true;
							$this.step = 3;

							var type;
							var rate;
							if($this.ltcDirection=='d'){
								type=3;
								rate=0.99;
							}else if($this.ltcDirection=='k'){
								type=4;
								rate=1.01
							}
							
							//保存remain

							$this.saveRemain = $this.remain;
							window.localStorage.setItem("saveRemain", String($this.remain))

							if($this.StopPrice===''){
								//刷新后没有这个price
								$this.StopPrice = parseFloat(window.localStorage.getItem("StopPrice"));
							}
							if($this.remain===''){
								//刷新后没有这个price
								$this.remain = parseFloat(window.localStorage.getItem("remain"));
							}

							var r = $this.remain;
							var t = type;
							var p = $this.StopPrice*rate;
							var zhisunOrder = {
								type: t,
								amount: r,
								price: p
							};
							$this.zhisunOrder = zhisunOrder;

							//下面下的单一定成交
							console.info("下止损单前的平仓量remain： "+$this.remain+", type: "+type)
							$this.futureTrade($this.StopPrice*rate,type,$this.remain);
							console.info("发出了止损单指令")




							$this.zaiCancelZhongXialeZhisun = true;
							//$this.stop = false;
							



							
						}else{
							$this.cancelSuc = false;
							console.info("撤单失败");

						}
					}else if(msg['channel']=="ok_sub_futureusd_ltc_ticker_quarter"){
						var data = msg['data'];
						$this.tickerData = data;

						if($this.tickerOrder==''&&$this.ltcBond==0&&$this.step==0){
							$this.step = 0.5
							$this.tradeLTC(data);
						}


					}else if(msg['channel']=="ok_sub_futureusd_ltc_trade_quarter"){
						var len = msg['data'].length;
						var data = msg['data'][len-1];
						var price = data[1];
						if($this.StopPrice!==''){
							if($this.ltcDirection=='d'){
								
								if(price<=$this.StopPrice && $this.step==2){
									//撤单//止损//下新单
									var order = $this.curPlantOrder;
									$this.curCancelId = order.order_id;
									$this.futureCancelOrder(order.order_id);
									console.info("cancel id is: "+order.order_id)

									$this.stop = true;
								}
							}else if($this.ltcDirection=='k'){
								if(price>=$this.StopPrice && $this.step==2){
									var order = $this.curPlantOrder;
									$this.curCancelId = order.order_id;
									$this.futureCancelOrder(order.order_id);
									console.info("cancel id is: "+order.order_id)
									$this.stop = true;
								}
							}
						}


					}
					//只有委托没有仓位
					//[{"contract_type":"this_week","freeze":0.01136364,"balance":0,"available":2.98263636,"contractid":20170714116,"bond":0,"profit":0,"unprofit":0}]
					//既有委托又有仓位
					//[{"contract_type":"this_week","freeze":0.01136364,"balance":0.01026602,"available":2.97237034,"contractid":20170714116,"bond":0.01020408,"profit":-0.00006194,"unprofit":0}]
					//有仓位没委托
					//[{"contract_type":"this_week","freeze":0,"balance":0.01026602,"available":2.98373398,"contractid":20170714116,"bond":0.01020408,"profit":-0.00006194,"unprofit":-0.00010}]
					//没委托没仓位
					//[{"contract_type":"this_week","freeze":0,"balance":0.00020698,"available":2.99379302,"contractid":20170714116,"bond":0,"profit":-0.00020698,"unprofit":0}]
					else if(msg['channel']=="ok_futureusd_userinfo"){
						var data = msg['data'];
						if(data.result==true){
							var objLTCInfo = data['info']['ltc']
							var quarterExist = false;
							if(objLTCInfo['contracts'].length == 0){
								$this.ltcBond = 0;
							}
							for(var i in objLTCInfo['contracts']){
								if(objLTCInfo['contracts'][i]['contract_type']=='quarter'){
									quarterExist = true;
									$this.ltcBond = objLTCInfo['contracts'][i]['bond']
									console.log("ltc bond get")
								}
							}
							if(quarterExist==false){
								$this.ltcBond = 0;
								console.info("没有也等于0了")
							}
						}else{
							$this.futureUserInfo();
						}


					}
					else if(msg['channel']=="ok_sub_futureusd_positions"){
						if(msg['data']['symbol']=='btc_usd'){
							var positionArr = msg['data']['positions']
							var dAmount=0;
							var kAmount=0;
							for(var i in positionArr){
								if(positionArr[i]['position']=='1'&&positionArr[i]['lever_rate']==20){
									console.info("dudaole position in array0,$this.changingAmount is: "+$this.changingAmount)
									dAmount = parseFloat(positionArr[i]['hold_amount']);
								}else if(positionArr[i]['position']=='2'&&positionArr[i]['lever_rate']==20){
									kAmount = parseFloat(positionArr[i]['hold_amount']);
								}
							}
							var delta = dAmount - kAmount;
							var max = dAmount - kAmount > 0 ? dAmount : kAmount;
							//if(Math.abs(delta)<=max*1/3){
							if(Math.abs(delta)<=$this.originArr[1]*2){
								$this.kaiduoRate1 = $this.origin;
								$this.changingAmount = 0;//说明常态
								$this.amountArr = $this.originArr;
							}else if(delta>0){
								//持有多仓大于空仓，应减少做空难度，增加空仓数量
								
								$this.kaiduoRate1 = 0.997


							}else{
								$this.kaiduoRate1 = 0.99852;
								console.info("add kaiduorate:"+$this.kaiduoRate1)

								
								var d = Math.floor(-delta/2)
								if(kAmount>50*$this.originArr[1]){
									$this.amountArr = $this.originArr;
									return;
								}
								if(d>10*$this.originArr[1]){
									d = 2*$this.originArr[1];
								}
								$this.changingAmount = d;
								console.log("update changingAmount:"+$this.changingAmount)
								$this.amountArr = [d,d,d,d];
								
							}
						}
						

					}
				}
			}else{
				var msg = array;
				for(var i in msg){
					if(msg[i]['channel']=="ok_sub_futureusd_positions"){
						if(msg[i]['data']['symbol']=='btc_usd'){
							var positionArr = msg[i]['data']['positions']
							var dAmount=0;
							var kAmount=0;
							for(var i in positionArr){
								
								if(positionArr[i]['position']=='1'&&positionArr[i]['lever_rate']==20){
									console.info("dudaole position in ARRAY")
									dAmount = parseFloat(positionArr[i]['hold_amount']);
									console.log("dAmount:"+dAmount)
								}else if(positionArr[i]['position']=='2'&&positionArr[i]['lever_rate']==20){
									kAmount = parseFloat(positionArr[i]['hold_amount']);
								}
								
							}
							var delta = dAmount - kAmount;
							var max = dAmount - kAmount > 0 ? dAmount : kAmount;
							//if(Math.abs(delta)<=max*1/3){
							if(Math.abs(delta)<=$this.originArr[1]*2){
								$this.kaiduoRate1 = $this.origin;
								$this.changingAmount = 0;//说明常态
								$this.amountArr = $this.originArr;

								console.info("reset kaiduorate:"+$this.kaiduoRate1)
							}else if(delta>0){
								//持有多仓大于空仓，应减少做空难度，增加空仓数量
								$this.kaiduoRate1 = 0.997
								console.info("add kaiduorate:"+$this.kaiduoRate1)

								

							}else{
								$this.kaiduoRate1 = 0.99852;
								console.info("add kaiduorate:"+$this.kaiduoRate1)

								
								var d = Math.floor(-delta/2)
								
								if(kAmount>50*$this.originArr[1]){
									$this.amountArr = $this.originArr;
									return;
								}
								if(d>10*$this.originArr[1]){
									d = 2*$this.originArr[1];
								}
								
								$this.changingAmount = d;
								console.log("update changingAmount:"+$this.changingAmount)
								$this.amountArr = [d,d,d,d];
								
								
								
								
							}

						}
						

					}else if(msg[i]['channel']=="ok_sub_futureusd_trades"){
						var data = msg[i]['data'];
						if(data.contract_name.indexOf("LTC")==0){
							if(data.type==3||data.type==4){
								if(data.status==1||data.status==0){
									$this.remain = data.amount - data.deal_amount;
									window.localStorage.setItem("remain",String($this.remain))
								}
							}
						}
						

					}
				}
			}



			if(array.event == 'pong') {
				$this.okCoinWebSocket.lastHeartBeat = new Date().getTime();
			} else {
				//$this.createTable(array);
			}
		},

		
		retreat: function(){
			var $this = this;
			
			if($this.cancelSuc===false){
				console.info("撤单失败，每秒尝试1次，尝试中.......")
				$this.futureCancelOrder($this.curCancelId);
			}
		},
		
		


		doSend: function(message) {
			var $this = this;
			//$this.sendCount++;

			if($this.okCoinWebSocket){
				var ws = $this.okCoinWebSocket.websocket
				this.send = function (message, callback) {
				    this.waitForConnection(function () {
				        ws.send(message);
				        if (typeof callback !== 'undefined') {
				          callback();
				        }
				    }, 100);
				};

				this.waitForConnection = function (callback, interval) {
				    if (ws.readyState === 1) {
				        callback();
				    } else {
				        var that = this;
				        // optional: implement backoff for interval here
				        setTimeout(function () {
				            that.waitForConnection(callback, interval);
				        }, interval);
				    }
				};


				this.send(message);
			}
			
			
		},
		onOpen: function(evt) {
			var $this = this;

			$this.connected++;
			var str = "{'event':'addChannel','channel':'"+$this.subKline+"'}"

			//订阅ltc合约行情，为了买一和卖一价格，作为baseprice
			var strTicker = "{'event':'addChannel','channel':'ok_sub_futureusd_ltc_ticker_quarter'}"

			//订阅大盘交易信息，为了判断是否破止损价
			var strDeal = "{'event':'addChannel','channel':'ok_sub_futureusd_ltc_trade_quarter'}"
			
			$this.doSend(str);
			$this.doSend(strTicker);
			$this.doSend(strDeal);

			$this.futurePositions();

			$this.futureTrades();


			


			
			
		},
		
	
		onError: function(evt) {
			var $this = this;

			$this.error++;
			$this.errorStr += error+'. '+evt.data;


		},
		onClose: function(evt) {
			var $this = this;

			$this.disconnected++;
		},
		checkConnect: function () {
			var $this = this;
			var ws = $this.okCoinWebSocket.websocket
			this.send = function (message, callback) {
			    this.waitForConnection(function () {
			        ws.send(message);
			        if (typeof callback !== 'undefined') {
			          callback();
			        }
			    }, 100);
			};

			this.waitForConnection = function (callback, interval) {
			    if (ws.readyState === 1) {
			        callback();
			    } else {
			        var that = this;
			        // optional: implement backoff for interval here
			        setTimeout(function () {
			            that.waitForConnection(callback, interval);
			        }, interval);
			    }
			};


			this.send("{'event':'ping'}");
			
			if ((new Date().getTime() - $this.okCoinWebSocket.lastHeartBeat) > $this.okCoinWebSocket.overtime) {
				console.log("socket 连接断开，正在尝试重新建立连接");
				//testWebSocket();
				$this.okCoinWebSocket.init("wss://real.okex.com:10440/websocket/okexapi", "0b8d2c87-cd53-4458-8a6a-ef7363a744fe", "DE9F7E166BD6ABED472C2B5FC21C4C29");

			}
		},
		futureOrderInfo: function(orderId) {
			//-1表示未完成订单
			console.info("i am querying info")
			var $this = this;
			var okCoinWebSocket = $this.okCoinWebSocket;
			/*var str = "api_key=" + okCoinWebSocket.api_key + "&contract_type=quarter&current_page=1&order_id=" + orderId + "&page_length=1&secret_key=" + okCoinWebSocket.secret_key + "&status=1&symbol=btc_usd"*/
			var str = "api_key=" + okCoinWebSocket.api_key + "&contract_type=quarter&current_page=1&order_id=" + orderId + "&page_length=50&status=1&symbol=ltc_usd&secret_key=" + okCoinWebSocket.secret_key

			var sign = MD5(str);
			$this.doSend("{'event': 'addChannel','channel': 'ok_futureusd_orderinfo','parameters': {'api_key': '"
					+ okCoinWebSocket.api_key + "','sign': '" + sign + "','symbol': 'ltc_usd','order_id': '" + orderId
					+ "','contract_type': 'quarter','status':'1','current_page':'1','page_length':'50'}}");
		},
		//合约下单
		futureTrade: function (price,type,amount) {
			var $this = this;
			var lv = $this.leverRate;
			
			$this.sendTime = new Date()
			var okCoinWebSocket = $this.okCoinWebSocket;
			var str = "amount="+ amount +"&api_key=" + okCoinWebSocket.api_key + 
					"&contract_type=quarter&lever_rate="+lv+"&match_price=0&price=" + price + "&symbol=ltc_usd&type="+ type +"&secret_key=" + okCoinWebSocket.secret_key
	
			var sign = MD5(str);
			$this.doSend("{'event': 'addChannel','channel':'ok_futureusd_trade','parameters': {'api_key': '"+ okCoinWebSocket.api_key + "','sign': '" + sign + "','symbol': 'ltc_usd','contract_type': 'quarter','amount': "+ amount +",'price': "+price+",'type': "+type+",'match_price': '0','lever_rate':" +lv+"}}");
			
		},
		//撤单
		futureCancelOrder: function(orderId) {
			var $this = this;
			var okCoinWebSocket = $this.okCoinWebSocket;
			var sign = MD5("api_key=" + okCoinWebSocket.api_key + "&contract_type=quarter&order_id=" + orderId
					+ "&symbol=ltc_usd&secret_key=" + okCoinWebSocket.secret_key);
			$this.doSend("{'event': 'addChannel','channel': 'ok_futureusd_cancel_order','parameters': {'api_key': '"
					+ okCoinWebSocket.api_key + "','sign': '" + sign + "','symbol': 'ltc_usd','order_id': '" + orderId
					+ "','contract_type': 'quarter'}}");
		},
		futurePositions: function() {
			var $this = this;
			var okCoinWebSocket = $this.okCoinWebSocket;
			var sign = MD5("api_key=" + okCoinWebSocket.api_key + "&secret_key=" + okCoinWebSocket.secret_key);
			$this.doSend("{'event':'addChannel','channel':'ok_sub_futureusd_positions','parameters' :{'api_key':'"
					+ okCoinWebSocket.api_key + "','sign':'" + sign + "'}}");
		},
		futureUserInfo:function () {
			var $this = this;
			var okCoinWebSocket = $this.okCoinWebSocket;
			var sign = MD5("api_key=" + okCoinWebSocket.api_key + "&secret_key=" + okCoinWebSocket.secret_key);
			$this.doSend("{'event':'addChannel','channel':'ok_futureusd_userinfo','parameters' :{'api_key':'"
					+ okCoinWebSocket.api_key + "','sign':'" + sign + "'}}");
		},
		futureTrades: function() {
			var $this = this;
			var okCoinWebSocket = $this.okCoinWebSocket;
			var sign = MD5("api_key=" + okCoinWebSocket.api_key + "&secret_key=" + okCoinWebSocket.secret_key);
			$this.doSend("{'event':'addChannel','channel':'ok_sub_futureusd_trades','parameters' :{'api_key':'"
					+ okCoinWebSocket.api_key + "','sign':'" + sign + "'}}");
		},
		setData:function(){
			var $this = this;

			/*for(var i in window.localStorage){
			  	console.log("this[i] is " + $this[i])
			  	$this[i] = window.localStorage[i];
			}*/
			var ls = window.localStorage;
			if(ls.getItem('ltcDirection')!==null){
				$this.ltcDirection = ls['ltcDirection'];
			}
			if(ls.getItem('StopPrice')!==null){
				$this.StopPrice = parseFloat(ls['StopPrice']);
			}
			if(ls.getItem('remain')!==null){
				$this.remain = parseFloat(ls['remain']);
			}
			if(ls.getItem('CloseLongRate')!==null){
				$this.CloseLongRate = parseFloat(ls['CloseLongRate']);
			}
			if(ls.getItem('CloseShortRate')!==null){
				$this.CloseShortRate = parseFloat(ls['CloseShortRate']);
			}
			if(ls.getItem('zhiDuoRate')!==null){
				$this.zhiDuoRate = parseFloat(ls['zhiDuoRate']);
			}
			if(ls.getItem('zhiKongRate')!==null){
				$this.zhiKongRate = parseFloat(ls['zhiKongRate']);
			}
			if(ls.getItem('ltcAmount')!==null){
				$this.ltcAmount = parseFloat(ls['ltcAmount']);
			}
			if(ls.getItem('hasLost')!==null){
				$this.hasLost = parseFloat(ls['hasLost']);
			}
			if(ls.getItem('kaiPrice')!==null){
				$this.kaiPrice = parseFloat(ls['kaiPrice']);
			}
			if(ls.getItem('saveRemain')!==null){
				$this.saveRemain = parseFloat(ls['saveRemain']);
			}
			
		}
						
	},
	mounted() {
		var $this = this;

		$this.setData();
		$this.okCoinWebSocket.init = function(uri, apiKey, secretKey) {
			this.wsUri = uri;
			this.api_key = apiKey;
			this.secret_key = secretKey;
			this.lastHeartBeat = new Date().getTime();
			this.overtime = 8000;
			var okCoinWebSocket = $this.okCoinWebSocket;
			
			okCoinWebSocket.websocket = new WebSocket(okCoinWebSocket.wsUri);
			
			okCoinWebSocket.websocket.onopen = function(evt) {
				$this.onOpen(evt)
			};
			okCoinWebSocket.websocket.onclose = function(evt) {
				$this.onClose(evt)
			};
			okCoinWebSocket.websocket.onmessage = function(evt) {
				$this.onMessage(evt)
			};
			okCoinWebSocket.websocket.onerror = function(evt) {
				$this.onError(evt)
			};
			
			setInterval($this.checkConnect,2000);
			
			setInterval($this.checkOrders,800);

			setInterval($this.ensureAllOrder,2000);

			//获取用户信息，检查保证金是否为0，为0则满足开仓条件之一
			setInterval($this.futureUserInfo,500);

			setInterval($this.retreat,1000);

		}
		$this.start();

		
				
	}
})
</script>
</html>